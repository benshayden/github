<!doctype html>
<title>Interactionator</title>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<style>
html * {
  max-height: 1000000px;
}
html, body {
  height: 100%;
}
body {
  max-width: 600px;
  padding: 0 1em;
  margin: 1em auto 0 auto;
}
#scroll, #load, #survey, #thanks {
  display: none;
}
#what {
  margin-bottom: 5em;
}
#click {
  display: block;
  margin: 0 auto;
  width: 80%;
  height: 3em;
}
#scroll {
  height: 200%;
  text-align: center;
}
#load {
  margin: 0 auto;
}
#thanks {
  margin: 0 auto;
  text-align: center;
}
canvas {
  display: block;
  margin: 0 auto 1em auto;
}
</style>

<div id=what>
  This Interaction Research Assistant will ask you to interact with the computer in a few different ways,
  then ask you how slow the computer felt:
  <button>too slow</button><button>fast enough</button>
  This survey will take about 30 seconds.
</div>

<button id=click>Click to begin!</button>

<div id=scroll>Scroll!</div>

<a href="/" id=load>Load a new page!</a>

<div id=survey>
  How slow was that delay?
  <button id=slow>too slow</button><button id=fast>fast enough</button>
</div>

<div id=thanks>
  Thanks for your help!
  <br>&nbsp;<br>
  <span class=legend>fast enough</span>
  <span class=legend>====</span>
  <span class=legend>====</span>
  <span class=legend>a bit slow</span>
  <span class=legend>====</span>
  <span class=legend>====</span>
  <span class=legend>pretty slow</span>
  <span class=legend>====</span>
  <span class=legend>====</span>
  <span class=legend>too slow</span>
  <br>&nbsp;<br>
</div>

<script>
var INTERACTIONS = ['click', 'scroll', 'load'];
var MAX_DELAY_MS = {click: 5e3, scroll: 1e3, load: 1e4};
var SLOWNESS_COLORS = [];

var legends = document.querySelectorAll('span.legend');
for (var i = 0; i < 10; ++i) {
  var red = Math.floor(255 * i / 10);
  var color = 'rgb(' + red + ',' + (255 - red) + ',0)';
  SLOWNESS_COLORS.push(color);
  legends[i].style.color = color;
}

var $ = function(id) { return document.getElementById(id); }

$('click').addEventListener('click', function() {
  $('click').disabled = true;
  scheduleSurvey('click');
});

var scrolled = false;
$('scroll').addEventListener('mousewheel', delayScroll);
$('scroll').addEventListener('touchmove', delayScroll);
function delayScroll(event) {
  event.preventDefault();
  if (scrolled)
    return;
  scrolled = true;
  scheduleSurvey('scroll');
}

$('load').addEventListener('click', function(event) {
  event.preventDefault();
  $('load').style.display = 'none';
  scheduleSurvey('load');
});

function startInteraction(interactionType) {
  scrolled = false;
  $('survey').style.display = 'none';
  INTERACTIONS.forEach(function(i) {
    $(i).style.display = (interactionType === i) ? 'block' : 'none';
  });
}

function scheduleSurvey(interactionType) {
  var startMs = new Date().getTime();
  var delayMs = Math.round(Math.random() * MAX_DELAY_MS[interactionType]);
  window.setTimeout(function() {
    showSurvey(interactionType, startMs);
    }, delayMs);
}

function showSurvey(interactionType, startMs) {
  // TODO if scroll then animate survey upwards to simulate scrolling
  $(interactionType).style.display = 'none';
  $('what').style.display = 'none';
  $('survey').style.display = 'block';
  var delayMs = new Date().getTime() - startMs;
  var done = false;
  function submit(event, slowness) {
    event.preventDefault();
    $('slow').removeEventListener('click', $('slow').clickHandler);
    $('slow').clickHandler = undefined;
    $('fast').removeEventListener('click', $('fast').clickHandler);
    $('fast').clickHandler = undefined;
    recordInteraction(interactionType, delayMs, slowness * 100));
    startNextInteractionAfter(interactionType);
  }
  $('slow').clickHandler = function(event) {
    submit(event, true);
  };
  $('slow').addEventListener('click', $('slow').clickHandler);
  $('fast').clickHandler = function(event) {
    submit(event, false);
  };
  $('fast').addEventListener('click', $('fast').clickHandler);
}

function startNextInteractionAfter(interactionType) {
  if ((INTERACTIONS.length - 1) === INTERACTIONS.indexOf(interactionType)) {
    // That was the last interactionType. Display a pretty graph.
    $('survey').style.display = 'none';
    $('thanks').style.display = 'block';
    getHistograms();
  } else {
    // Start the next interaction.
    startInteraction(INTERACTIONS[1 + INTERACTIONS.indexOf(interactionType)]);
  }
}

function recordInteraction(interactionType, delayMs, slowness) {
  var xhr = new XMLHttpRequest();
  xhr.open('POST', '/record', true);
  xhr.setRequestHeader('Content-type', 'application/x-www-form-urlencoded');
  xhr.send('interactionType=' + interactionType +
          '&delayMs=' + delayMs +
          '&slowness=' + slowness);
}

function getHistograms() {
  var xhr = new XMLHttpRequest();
  xhr.open('GET', '/graph', true);
  xhr.onload = function() {
    var histograms = JSON.parse(xhr.responseText);
    histograms.forEach(chartHistogram);
  };
  xhr.send();
}

function chartHistogram(histogram) {
  var interactionType = histogram[0];
  var interactionSampleCount = histogram[1];
  var canvas = document.createElement('canvas');
  canvas.width = 600;
  canvas.height = 600;
  $('thanks').appendChild(document.createTextNode(interactionType));
  $('thanks').appendChild(canvas);
  var context = canvas.getContext('2d');
  var prevX = 0;
  var slownessMeans = [];
  context.font = '14px Arial';
  var bottomMargin = context.measureText('0').height + 10;
  var prevXAxis = 0;
  histogram[2].forEach(function(delayHistogram) {
    var delayMs = delayHistogram[0] * 10;
    var delaySampleCount = delayHistogram[1];
    var x = canvas.width * delayMs / MAX_DELAY_MS[interactionType];
    var prevY = canvas.height - bottomMargin;
    var avgSlowness = 0;
    if (x > prevXAxis) {
      var xAxisWidth = context.measureText('' + delayMs).width;
      context.fillText('' + delayMs, x, canvas.height);
      prevXAxis = x + xAxisWidth;
    }
    delayHistogram[2].forEach(function(slownessBucket) {
      var slowness = slownessBucket[0] * 10;
      var count = slownessBucket[1];
      avgSlowness += slowness * count / delaySampleCount;
      context.fillStyle = SLOWNESS_COLORS[slownessBucket[0]];
      var height = canvas.height * count / delaySampleCount;
      console.debug(interactionType, 'delayMs', delayMs, 'slowness', slowness, 'count', count, 'prevX', prevX, 'x', x, 'prevY', prevY, 'y', prevY - height, 'height', height, 'width', x - prevX);
      context.fillRect(prevX, prevY - height, x - prevX, height);
      prevY -= height;
    });
    slownessMeans.push([(prevX + (x - prevX) / 2), canvas.height * avgSlowness / 100]);
    prevX = x;
  });
  context.beginPath();
  context.moveTo(slownessMeans[0][0], slownessMeans[0][1]);
  slownessMeans.slice(1).forEach(function(point) {
    context.lineTo(point[0], point[1]);
  });
  context.stroke();
}
</script>
