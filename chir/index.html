<!doctype html>
<title>Interactionator</title>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<style>
html * {
  max-height: 1000000px;
}
html, body {
  height: 100%;
}
body {
  max-width: 600px;
  padding: 0 1em;
  margin: 1em auto 0 auto;
}
#scroll, #load, #survey, #thanks {
  display: none;
}
#what {
  margin-bottom: 5em;
}
#click {
  display: block;
  margin: 0 auto;
  width: 80%;
  height: 3em;
}
#scroll {
  height: 200%;
  text-align: center;
}
#load {
  margin: 0 auto;
}
.slowness {
  display: flex;
  flex-direction: row;
  margin: 1em;
}
.slowness > input {
  flex-grow: 1;
}
#submit {
  display: block;
  margin: 0 auto;
  width: 80%;
  height: 2em;
}
#thanks {
  margin: 0 auto;
  text-align: center;
}
canvas {
  display: block;
  margin: 0 auto 1em auto;
}
</style>

<div id=what>
  This Interaction Research Assistant will ask you to interact with the computer in a few different ways,
  then ask you how slow the computer felt:
  <div class=slowness>
    <div>too slow</div>
    <input type=range>
    <div>fast enough</div>
  </div>
  This survey will take about 30 seconds.
</div>

<button id=click>Click to begin!</button>

<div id=scroll>Scroll!</div>

<a href="/" id=load>Load a new page!</a>

<div id=survey>
  How slow was that delay?
  <div class=slowness>
    <div>too slow</div>
    <input type=range id=slowness>
    <div>fast enough</div>
  </div>
  <button id=submit></button>
</div>

<div id=thanks>
  Thanks for your help!
  <br>&nbsp;<br>
</div>

<script>
var INTERACTIONS = ['click', 'scroll', 'load'];
var MAX_DELAY_MS = {click: 5e3, scroll: 1e3, load: 1e4};
var SLOWNESS_COLORS = [];

for (var i = 0; i < 10; ++i) {
  var red = Math.floor(255 * i / 10);
  SLOWNESS_COLORS.push('rgb(' + red + ',' + (255 - red) + ',0)');
}

var $ = function(id) { return document.getElementById(id); }

$('click').addEventListener('click', function() {
  $('click').disabled = true;
  scheduleSurvey('click');
});

var scrolled = false;
$('scroll').addEventListener('mousewheel', delayScroll);
$('scroll').addEventListener('touchmove', delayScroll);
function delayScroll(event) {
  event.preventDefault();
  if (scrolled)
    return;
  scrolled = true;
  scheduleSurvey('scroll');
}

$('load').addEventListener('click', function(event) {
  event.preventDefault();
  $('load').style.display = 'none';
  scheduleSurvey('load');
});

function startInteraction(interactionType) {
  scrolled = false;
  $('survey').style.display = 'none';
  INTERACTIONS.forEach(function(i) {
    $(i).style.display = (interactionType === i) ? 'block' : 'none';
  });
}

function scheduleSurvey(interactionType) {
  var startMs = new Date().getTime();
  var delayMs = Math.round(Math.random() * MAX_DELAY_MS[interactionType]);
  window.setTimeout(function() {
    showSurvey(interactionType, startMs);
    }, delayMs);
}

$('slowness').addEventListener('mousedown', enableSubmit);
$('slowness').addEventListener('touchstart', enableSubmit);
function enableSubmit() {
  $('submit').disabled = false;
  $('submit').textContent = 'That slow!';
}
$('slowness').previousElementSibling.addEventListener('mousedown', setTooSlow);
$('slowness').previousElementSibling.addEventListener('touchstart', setTooSlow);
function setTooSlow() {
  $('slowness').value = 0;
  enableSubmit();
}
$('slowness').nextElementSibling.addEventListener('mousedown', setFastEnough);
$('slowness').nextElementSibling.addEventListener('touchstart', setFastEnough);
function setFastEnough() {
  $('slowness').value = 100;
  enableSubmit();
}

function showSurvey(interactionType, startMs) {
  // TODO if scroll then animate survey upwards to simulate scrolling
  $(interactionType).style.display = 'none';
  $('what').style.display = 'none';
  $('slowness').value = 50;
  $('submit').textContent = 'How slow was that delay?';
  $('submit').disabled = true;
  $('survey').style.display = 'block';
  var delayMs = new Date().getTime() - startMs;
  $('submit').clickHandler = function(event) {
    event.preventDefault();
    $('submit').removeEventListener('click', $('submit').clickHandler);
    $('submit').clickHandler = undefined;
    recordInteraction(interactionType, delayMs, 100 - parseInt($('slowness').value));
  };
  $('submit').addEventListener('click', $('submit').clickHandler);
}

function recordInteraction(interactionType, delayMs, slowness) {
  var xhr = new XMLHttpRequest();
  xhr.open('POST', '/record', true);
  xhr.setRequestHeader('Content-type', 'application/x-www-form-urlencoded');
  xhr.send('interactionType=' + interactionType +
          '&delayMs=' + delayMs +
          '&slowness=' + slowness);

  if ((INTERACTIONS.length - 1) === INTERACTIONS.indexOf(interactionType)) {
    // That was the last interactionType. Display a pretty graph.
    $('survey').style.display = 'none';
    $('thanks').style.display = 'block';
    getHistograms();
  } else {
    // Start the next interaction.
    startInteraction(INTERACTIONS[1 + INTERACTIONS.indexOf(interactionType)]);
  }
}

function getHistograms() {
  var xhr = new XMLHttpRequest();
  xhr.open('GET', '/graph', true);
  xhr.onload = function() {
    var histograms = JSON.parse(xhr.responseText);
    /* [(interactionType, sampleCount, sorted[
          (delayMs/10, sampleCount, sorted[
             (slowness/10, count)])]]
    */
    histograms.forEach(function(histogram) {
      var interactionType = histogram[0];
      var interactionSampleCount = histogram[1];
      var canvas = document.createElement('canvas');
      canvas.width = 600;
      canvas.height = 600;
      $('thanks').appendChild(document.createTextNode(interactionType));
      $('thanks').appendChild(canvas);
      var context = canvas.getContext('2d');
      var prevX = 0;
      var slownessMeans = [];
      histogram[2].forEach(function(delayHistogram) {
        var delayMs = delayHistogram[0] * 10;
        var delaySampleCount = delayHistogram[1];
        var x = canvas.width * delayMs / MAX_DELAY_MS[interactionType];
        var prevY = canvas.height;
        var avgSlowness = 0;
        delayHistogram[2].forEach(function(slownessBucket) {
          var slowness = slownessBucket[0] * 10;
          var count = slownessBucket[1];
          avgSlowness += slowness * count / delaySampleCount;
          context.fillStyle = SLOWNESS_COLORS[slownessBucket[0]];
          var height = canvas.height * count / delaySampleCount;
          console.debug(interactionType, 'delayMs', delayMs, 'slowness', slowness, 'count', count, 'prevX', prevX, 'x', x, 'prevY', prevY, 'y', prevY - height, 'height', height, 'width', x - prevX);
          context.fillRect(x, prevY - height, x - prevX, height);
          prevY -= height;
        });
        if (prevAvgSlowness) {
          context.beginPath();
          context.moveTo(prevX, canvas.height * prevAvgSlowness / 100);
          context.lineTo(x, canvas.height * avgSlowness / 100);
          context.stroke();
        }
        prevX = x;
        prevAvgSlowness = avgSlowness;
      });
    });
  };
  xhr.send();
}
</script>
