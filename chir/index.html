<!doctype html>
<title>Interactionator</title>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<style>
html * {
  max-height: 1000000px;
}
body {
  height: 100%;
}
body {
  max-width: 600px;
  padding: 0 1em;
  margin: 1em auto 0 auto;
}
#scroll, #load, #survey, #thanks {
  display: none;
}
#what {
  margin-bottom: 5em;
}
#click {
  display: block;
  margin: 0 auto;
  width: 80%;
}
button {
  height: 3em;
}
#scroll {
  height: 100%;
}
#load {
  margin: 0 auto;
}
#thanks {
  margin: 0 auto;
}
#survey, #thanks, #load, #scroll {
  text-align: center;
}
flex {
  display: flex;
}
flex > * {
  flex-grow: 1;
  margin: 1em;
}
canvas {
  display: block;
  margin: 0 auto 1em auto;
}
</style>

<div id=what>
  This Interaction Research Assistant will ask you to interact with the computer in a few different ways,
  then ask you how slow the computer felt:
  <flex><button>too slow</button><button>fast enough</button></flex>
  This survey will take about 30 seconds.
</div>

<button id=click>Click!</button>

<div id=scroll>Scroll!</div>

<a href="/" id=load>Load a new page!</a>

<div id=survey>
  How slow was that delay?
  <flex><button id=slow>too slow</button><button id=fast>fast enough</button></flex>
</div>

<div id=thanks>
  Thanks for your help!
  <br>&nbsp;<br>
</div>

<script>
var INTERACTIONS = ['click', 'scroll', 'load'];
var MAX_DELAY_MS = {click: 5e3, scroll: 1e3, load: 1e4};

var $ = function(id) { return document.getElementById(id); }

$('click').addEventListener('click', function() {
  $('click').disabled = true;
  scheduleSurvey('click');
});

var scrolled = false;
$('scroll').addEventListener('mousewheel', delayScroll);
$('scroll').addEventListener('touchmove', delayScroll);
function delayScroll(event) {
  event.preventDefault();
  if (scrolled)
    return;
  scrolled = true;
  scheduleSurvey('scroll');
}

$('load').addEventListener('click', function(event) {
  event.preventDefault();
  $('load').style.display = 'none';
  scheduleSurvey('load');
});

function startInteraction(interactionType) {
  scrolled = false;
  var isScroll = (interactionType === 'scroll');
  $('survey').style.display = isScroll ? 'block' : 'none';
  document.children[0].style.height = isScroll ? '100%' : '';
  INTERACTIONS.forEach(function(i) {
    $(i).style.display = (interactionType === i) ? 'block' : 'none';
  });
}

function scheduleSurvey(interactionType) {
  var startMs = new Date().getTime();
  var delayMs = Math.round(Math.random() * MAX_DELAY_MS[interactionType]);
  window.setTimeout(function() {
    showSurvey(interactionType, startMs);
    }, delayMs);
}

function showSurvey(interactionType, startMs) {
  if (interactionType === 'scroll') {
    var scrollHeight = $('scroll').getBoundingClientRect().height;
    if (scrollHeight > 20)) {
      $('scroll').style.height = (scrollHeight - 20) + 'px';
      window.requestAnimationFrame(showSurvey);
      return;
    }
  }
  $(interactionType).style.display = 'none';
  $('what').style.display = 'none';
  $('survey').style.display = 'block';
  var delayMs = new Date().getTime() - startMs;
  var done = false;
  function submit(event, slowness) {
    event.preventDefault();
    $('slow').removeEventListener('click', $('slow').clickHandler);
    $('slow').clickHandler = undefined;
    $('fast').removeEventListener('click', $('fast').clickHandler);
    $('fast').clickHandler = undefined;
    recordInteraction(interactionType, delayMs, slowness);
    startNextInteractionAfter(interactionType);
  }
  $('slow').clickHandler = function(event) {
    submit(event, 100);
  };
  $('slow').addEventListener('click', $('slow').clickHandler);
  $('fast').clickHandler = function(event) {
    submit(event, 0);
  };
  $('fast').addEventListener('click', $('fast').clickHandler);
}

function startNextInteractionAfter(interactionType) {
  if ((INTERACTIONS.length - 1) === INTERACTIONS.indexOf(interactionType)) {
    // That was the last interactionType. Display a pretty graph.
    $('survey').style.display = 'none';
    $('thanks').style.display = 'block';
    getHistograms();
  } else {
    // Start the next interaction.
    startInteraction(INTERACTIONS[1 + INTERACTIONS.indexOf(interactionType)]);
  }
}

function recordInteraction(interactionType, delayMs, slowness) {
  var xhr = new XMLHttpRequest();
  xhr.open('POST', '/record', true);
  xhr.setRequestHeader('Content-type', 'application/x-www-form-urlencoded');
  xhr.send('interactionType=' + interactionType +
          '&delayMs=' + delayMs +
          '&slowness=' + slowness);
}

function getHistograms() {
  var xhr = new XMLHttpRequest();
  xhr.open('GET', '/graph', true);
  xhr.onload = function() {
    var histograms = JSON.parse(xhr.responseText);
    histograms.forEach(chartHistogram);
  };
  xhr.send();
}

function chartHistogram(histogram) {
  var interactionType = histogram[0];
  histogram = histogram[1];
  var canvas = document.createElement('canvas');
  canvas.width = 600;
  canvas.height = 600;
  $('thanks').appendChild(document.createTextNode(interactionType));
  $('thanks').appendChild(canvas);
  var context = canvas.getContext('2d');
  context.font = '14px Arial';
  var bottomMargin = context.measureText('0').height + 10;
  var leftMargin = 0;
  var prevXAxis = 0;
  var prevCanvasPoint = undefined;
  histogram.forEach(function(point, index) {
    var canvasPoint = [(canvas.width - leftMargin) * point[0] / MAX_DELAY_MS[interactionType],
                       (canvas.height - bottomMargin) * (1 - point[1])];
    if (prevCanvasPoint) {
      context.beginPath();
      context.moveTo(prevCanvasPoint[0], prevCanvasPoint[1]);
      context.lineTo(canvasPoint[0], canvasPoint[1]);
      context.stroke();
    }
    var avgSlowness = 0;
    if (canvasPoint[0] > prevXAxis) {
      var xAxisWidth = context.measureText(point[0] + ' ').width;
      context.fillText('' + point[0], canvasPoint[0], canvas.height);
      prevXAxis = canvasPoint[0] + xAxisWidth;
    }
    prevCanvasPoint = canvasPoint;
  });
}
</script>
