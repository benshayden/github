<!doctype html>
<title>Interactionator</title>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<style>
html * {
  max-height: 1000000px;
}
html, body {
  height: 100%;
}
body {
  max-width: 600px;
  margin: 1em auto 0 auto;
}
#scroll, #load, #survey, #thanks {
  display: none;
}
#what {
  margin-bottom: 5em;
}
#click {
  display: block;
  margin: 0 auto;
  width: 80%;
  height: 3em;
}
#scroll {
  height: 200%;
  text-align: center;
}
#load {
  margin: 0 auto;
}
.slowness {
  display: flex;
  flex-direction: row;
  margin: 1em;
}
.slowness > input {
  flex-grow: 1;
}
#submit {
  display: block;
  margin: 0 auto;
  width: 80%;
  height: 2em;
}
#thanks {
  margin: 0 auto;
}
</style>

<div id=what>
  This Interaction Research Assistant will ask you to interact with the computer in a few different ways,
  then ask you how slow the computer felt:
  <div class=slowness>
    <div>too slow</div>
    <input type=range>
    <div>fast enough</div>
  </div>
</div>

<button id=click>Click to begin!</button>

<div id=scroll>Scroll!</div>

<a href="/" id=load>Load a new page!</a>

<div id=survey>
  How slow was that delay?
  <div class=slowness>
    <div>too slow</div>
    <input type=range id=slowness>
    <div>fast enough</div>
  </div>
  <button id=submit></button>
</div>

<div id=thanks>
  Thanks for your help!
  <br>TODO graph results
</div>

<script>
var INTERACTIONS = ['click', 'scroll', 'load'];

var $ = function(id) { return document.getElementById(id); }

$('click').addEventListener('click', function() {
  $('click').disabled = true;
  scheduleSurvey('click', 5e3);
});

var scrolled = false;
$('scroll').addEventListener('mousewheel', delayScroll);
$('scroll').addEventListener('touchmove', delayScroll);
function delayScroll(event) {
  event.preventDefault();
  if (scrolled)
    return;
  scrolled = true;
  scheduleSurvey('scroll', 1e3);
}

$('load').addEventListener('click', function(event) {
  event.preventDefault();
  $('load').style.display = 'none';
  scheduleSurvey('load', 1e4);
});

function startInteraction(interactionType) {
  scrolled = false;
  $('survey').style.display = 'none';
  INTERACTIONS.forEach(function(i) {
    $(i).style.display = (interactionType === i) ? 'block' : 'none';
  });
}

function scheduleSurvey(interactionType, max_ms) {
  var startMs = new Date().getTime();
  var delayMs = Math.round(Math.random() * max_ms);
  window.setTimeout(function() {
    showSurvey(interactionType, startMs);
    }, delayMs);
}

$('slowness').addEventListener('mousedown', enableSubmit);
$('slowness').addEventListener('touchstart', enableSubmit);
function enableSubmit() {
  $('submit').disabled = false;
  $('submit').textContent = 'That slow!';
}
$('slowness').previousElementSibling.addEventListener('mousedown', setTooSlow);
$('slowness').previousElementSibling.addEventListener('touchstart', setTooSlow);
function setTooSlow() {
  $('slowness').value = 0;
  enableSubmit();
}
$('slowness').nextElementSibling.addEventListener('mousedown', setFastEnough);
$('slowness').nextElementSibling.addEventListener('touchstart', setFastEnough);
function setFastEnough() {
  $('slowness').value = 100;
  enableSubmit();
}

function showSurvey(interactionType, startMs) {
  // TODO if scroll then animate survey upwards to simulate scrolling
  $(interactionType).style.display = 'none';
  $('what').style.display = 'none';
  $('slowness').value = 50;
  $('submit').textContent = 'How slow was that delay?';
  $('submit').disabled = true;
  $('survey').style.display = 'block';
  var delayMs = new Date().getTime() - startMs;
  $('submit').clickHandler = function(event) {
    event.preventDefault();
    $('submit').removeEventListener('click', $('submit').clickHandler);
    $('submit').clickHandler = undefined;
    recordInteraction(interactionType, delayMs, 100 - parseInt($('slowness').value));
  };
  $('submit').addEventListener('click', $('submit').clickHandler);
}

function recordInteraction(interactionType, delayMs, slowness) {
  var xhr = new XMLHttpRequest();
  xhr.open('POST', '/record', true);
  xhr.setRequestHeader('Content-type', 'application/x-www-form-urlencoded');
  xhr.send('interactionType=' + interactionType +
          '&delayMs=' + delayMs +
          '&slowness=' + slowness);

  if ((INTERACTIONS.length - 1) === INTERACTIONS.indexOf(interactionType)) {
    // That was the last interaction interactionType. Display a pretty graph.
    $('survey').style.display = 'none';
    $('graph').style.display = 'block';
    getHistograms();
  } else {
    // Start the next interaction.
    startInteraction(INTERACTIONS[1 + INTERACTIONS.indexOf(interactionType)]);
  }
}

function getHistograms() {
  var xhr = new XMLHttpRequest();
  xhr.open('GET', '/graph', true);
  xhr.onload = function() {
    // TODO
  };
  xhr.send();
}
</script>
