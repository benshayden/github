<!doctype html>
<title>Interactionator</title>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<style>
html * {
  max-height: 1000000px;
}
body {
  height: 100%;
}
body {
  max-width: 600px;
  padding: 0 1em;
  margin: 1em auto 0 auto;
}
#scroll, #load, #survey, #thanks {
  display: none;
}
#what {
  margin-bottom: 5em;
}
#click {
  display: block;
  margin: 0 auto;
  width: 80%;
}
button {
  height: 3em;
}
#scroll {
  height: 100%;
}
#load {
  margin: 0 auto;
}
#thanks {
  margin: 0 auto;
}
#survey, #thanks, #load, #scroll {
  text-align: center;
}
flex {
  display: flex;
}
flex > * {
  flex-grow: 1;
  margin: 1em;
}
canvas {
  display: block;
  margin: 0 auto 3em auto;
}
</style>

<div id=what>
  This Interaction Research Assistant will ask you to interact with the computer in a few different ways,
  then ask you how slow the computer felt:
  <flex><button>too slow</button><button>fast enough</button></flex>
  This survey will take about 60 seconds.
</div>

<button id=click>Click!</button>

<div id=scroll>Scroll!</div>

<a href="/" id=load>Load a new page!</a>

<div id=survey>
  How slow was that delay?
  <flex><button id=slow>too slow</button><button id=fast>fast enough</button></flex>
</div>

<div id=thanks>
  Thanks for your help!
  <br>&nbsp;<br>
</div>

<script>
var INTERACTIONS = ['click', 'scroll', 'load'];
var INTERACTION_REPEAT = {click: 4, scroll: 5, load: 3};
var MAX_DELAY_MS = {click: 2e3, scroll: 1e3, load: 5e3};

var $ = function(id) { return document.getElementById(id); }

$('click').addEventListener('click', function() {
  $('click').disabled = true;
  scheduleSurvey('click');
});

var scrolled = false;
$('scroll').addEventListener('mousewheel', delayScroll);
$('scroll').addEventListener('touchmove', delayScroll);
function delayScroll(event) {
  event.preventDefault();
  if (scrolled)
    return;
  scrolled = true;
  scheduleSurvey('scroll');
}

$('load').addEventListener('click', function(event) {
  event.preventDefault();
  $('load').style.display = 'none';
  scheduleSurvey('load');
});

function startInteraction(interactionType) {
  scrolled = false;
  var isScroll = (interactionType === 'scroll');
  $('click').disabled = false;
  $('scroll').style.height = '100%';
  $('survey').style.display = isScroll ? 'block' : 'none';
  document.children[0].style.height = isScroll ? '100%' : '';
  INTERACTIONS.forEach(function(i) {
    $(i).style.display = (interactionType === i) ? 'block' : 'none';
  });
}

function scheduleSurvey(interactionType) {
  var startMs = new Date().getTime();
  var delayMs = MAX_DELAY_MS[interactionType];
  // Artificially force the first scroll to have max delay to illustrate
  // how we're interested in the initial delay,
  // not the speed or jank of the artificial animation.
  if ((interactionType !== 'scroll') || (interactionCounter !== 0)) {
    delayMs = Math.round(Math.random() * delayMs);
  }
  window.setTimeout(function() {
    showSurvey(interactionType, startMs);
    }, delayMs);
}

var SCROLL_FRAME_PX = 50;

function showSurvey(interactionType, startMs) {
  if (interactionType === 'scroll') {
    var scrollHeight = $('scroll').getBoundingClientRect().height;
    if (scrollHeight > SCROLL_FRAME_PX) {
      $('scroll').style.height = (scrollHeight - SCROLL_FRAME_PX) + 'px';
      window.requestAnimationFrame(function() {
        showSurvey(interactionType, startMs);
      });
      return;
    }
  }
  $(interactionType).style.display = 'none';
  $('what').style.display = 'none';
  $('survey').style.display = 'block';
  var delayMs = new Date().getTime() - startMs;
  var done = false;
  function submit(event, comfort) {
    event.preventDefault();
    $('slow').removeEventListener('click', $('slow').clickHandler);
    $('slow').clickHandler = undefined;
    $('fast').removeEventListener('click', $('fast').clickHandler);
    $('fast').clickHandler = undefined;
    recordInteraction(interactionType, delayMs, comfort);
    startNextInteractionAfter(interactionType);
  }
  $('slow').clickHandler = function(event) {
    submit(event, 0);
  };
  $('slow').addEventListener('click', $('slow').clickHandler);
  $('fast').clickHandler = function(event) {
    submit(event, 100);
  };
  $('fast').addEventListener('click', $('fast').clickHandler);
}

var interactionCounter = 0;

function startNextInteractionAfter(interactionType) {
  if (interactionCounter < INTERACTION_REPEAT[interactionType]) {
    ++interactionCounter;
    startInteraction(interactionType);
    return;
  }
  interactionCounter = 0;
  var index = INTERACTIONS.indexOf(interactionType);
  if (index === (INTERACTIONS.length - 1)) {
    // That was the last interactionType. Display a pretty graph.
    $('survey').style.display = 'none';
    $('thanks').style.display = 'block';
    // getHistograms();
  } else {
    // Start the next interaction.
    startInteraction(INTERACTIONS[1 + index]);
  }
}

function recordInteraction(interactionType, delayMs, comfort) {
  // Don't record the artificial max-delay scroll, or it will screw up the histogram.
  if (interactionType === 'scroll' && delayMs === MAX_DELAY_MS.scroll)
    return;
  var xhr = new XMLHttpRequest();
  xhr.open('POST', '/record', true);
  xhr.setRequestHeader('Content-type', 'application/x-www-form-urlencoded');
  xhr.send('interactionType=' + interactionType +
          '&delayMs=' + delayMs +
          '&comfort=' + comfort);
}

function getHistograms() {
  var xhr = new XMLHttpRequest();
  xhr.open('GET', '/graph', true);
  xhr.onload = function() {
    var histograms = JSON.parse(xhr.responseText);
    histograms.forEach(chartHistogram);
  };
  xhr.send();
}

function chartHistogram(histogram) {
  var interactionType = histogram[0];
  var maxDelayMs = MAX_DELAY_MS[interactionType];
  histogram = histogram[1];
  var canvas = document.createElement('canvas');
  canvas.width = 400;
  canvas.height = 400;
  $('thanks').appendChild(document.createTextNode(interactionType + ' comfort'));
  $('thanks').appendChild(canvas);
  var context = canvas.getContext('2d');

  context.font = '14px Arial';

  var topMargin = 16;
  var bottomMargin = 26;
  var leftMargin = context.measureText('100').width + 12;
  var rightMargin = context.measureText(maxDelayMs).width + 2;
  var prevXAxis = 0;
  var prevCanvasPoint = undefined;

  context.beginPath();
  context.moveTo(canvas.width, canvas.height - bottomMargin);
  context.lineTo(leftMargin, canvas.height - bottomMargin);
  context.lineTo(leftMargin, 0);
  context.stroke();

  for (var pct = 0; pct <= 100; pct += 10) {
    context.beginPath();
    var y = topMargin + ((canvas.height - bottomMargin - topMargin) * (1 - pct / 100));
    context.moveTo(leftMargin, y);
    context.lineTo(leftMargin - 10, y);
    context.stroke();
    context.fillText('' + pct, 1, y);
  }

  histogram.forEach(function(point, index) {
    var canvasPoint = [];
    canvasPoint[0] = leftMargin + (canvas.width - leftMargin - rightMargin) *
      point[0] / maxDelayMs;
    canvasPoint[1] = topMargin + ((canvas.height - bottomMargin - topMargin) * (1 - (point[1] / 100)));
    if (prevCanvasPoint) {
      context.beginPath();
      context.moveTo(prevCanvasPoint[0], prevCanvasPoint[1]);
      context.lineTo(canvasPoint[0], canvasPoint[1]);
      context.stroke();
    }

    if (canvasPoint[0] > prevXAxis) {
      context.beginPath();
      context.moveTo(canvasPoint[0], canvas.height - bottomMargin);
      context.lineTo(canvasPoint[0], canvas.height - bottomMargin + 10);
      context.stroke();
      var xAxisWidth = context.measureText(point[0] + ' ').width;
      context.fillText('' + point[0], canvasPoint[0], canvas.height);
      prevXAxis = canvasPoint[0] + xAxisWidth;
    }
    prevCanvasPoint = canvasPoint;
  });
}
</script>
