<!doctype html>
<style>
html {
  font-family: monospace;
  background: black;
  color: white;
}
cursor {
  background: white;
  color: black;
}
</style>
<cursor>&nbsp;</cursor>
<script>
var cursor = document.querySelector('cursor');
var buffer = '';

addEventListener('keypress', handle);
function handle(event) {
  event = event.keyCode;
  if ((event < 97) || (event > 122)) return;
  event = String.fromCharCode(event);
  buffer += event;
  if (commands[buffer]) {
    commands[buffer]();
    buffer = '';
  } else if (buffer.length > maxcmdlen) {
    buffer = '';
  }
}

var commands = {};
var maxcmdlen = 1;

function randCmd(n) {
  n = n || 2;
  var cmd = '';
  while (!cmd || commands[cmd]) {
    cmd = '';
    for (var i = 0; i < n; ++i) {
      cmd += String.fromCharCode(97 + Math.floor(Math.random() * 26));
    }
  }
  if (n > maxcmdlen) {
    maxcmdlen = n;
  }
  return cmd;
}

function def(msg, cb) {
  var cmd = randCmd();
  console.debug(cmd, msg);
  commands[cmd] = cb;
}

function inserter(char) {
  def(char, function() {
    document.body.insertBefore(document.createTextNode(char), cursor);
  });
}

def('back', function() {
  document.body.removeChild(cursor.previousSibling);
});

for (var i = 33; i < 126; ++i) {
  (function(i) {
    inserter(String.fromCharCode(i));
  })(i);
}
inserter(String.fromCharCode(160));

def('newline', function() {
  document.body.insertBefore(document.createElement('br'), cursor);
});

def('left', function() {
  if (!cursor.previousSibling) return;
  var newcursor = document.createElement('cursor');
  var text = cursor.previousSibling;
  // TODO text is br?
  document.body.removeChild(text);
  newcursor.appendChild(text);
  document.body.insertBefore(newcursor, cursor);
  text = cursor.childNodes[0];
  cursor.removeChild(text);
  document.body.insertBefore(text, cursor);
  document.body.removeChild(cursor);
  cursor = newcursor;
});

def('right', function() {
  if (!cursor.nextSibling) return;
  var newcursor = document.createElement('cursor');
  var text = cursor.nextSibling;
  // TODO text is br?
  document.body.removeChild(text);
  newcursor.appendChild(text);
  text = cursor.childNodes[0];
  cursor.removeChild(text);
  document.body.insertBefore(text, cursor);
  document.body.insertBefore(newcursor, cursor);
  document.body.removeChild(cursor);
  cursor = newcursor;
});
</script>
