<!doctype html>
<!--
  TODO
  cell onclick => display notes, parts for root, root-not, root-.+, .+-root-.*
-->
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>oligosynthesizer</title>
<style>
  table {
    border-collapse: collapse;
    margin: auto;
  }
  td {
    padding: 2px 8px;
    text-align: center;
    border: 1px solid lightgrey;
  }
  tx {
    font-style: italic;
  }
</style>

<center>
  <div id=name_en></div>
  <tx id=name></tx>
</center>

<button id="authorize_button">Authorize Google Sheets API</button>

<p>Roots
<table id=syllables></table>

<p>Words
<div style="max-height: 19.5em; overflow: auto; margin: auto;">
  <table id=words></table>
</div>

<p>Sentences
<div style="max-height: 19.5em; overflow: auto; margin: auto;">
</div>

<p>Compare toki pona vocabulary
<div style="max-height: 19.5em; overflow: auto; margin: auto;">
  <table id=tokipona></table>
</div>

<p>Compare aUI vocabulary
<div style="max-height: 19.5em; overflow: auto; margin: auto;">
  <table id=aui></table>
</div>

<p>Transliterate
<div style="display: flex;">
  <textarea id=en style="flex-grow: 1;"></textarea>
  <textarea id=fw style="flex-grow: 1;"></textarea>
</div>

<p id=about></p>

<script>
const spreadsheetId = '1lOF5iFM41Au5nf6oFgHLb7-kZQbtxVINLYktcYpjVsQ';
const F = {
  fw2en: {},
  en2fw: {},
  
  phrase(s, strict = false) {
    let fw = '';
    for (const en of s.split(' ')) {
      if (strict && !F.en2fw[en]) throw new Error(en);
      fw += ' ' + (F.en2fw[en] || en);
    }
    return fw;
  },

  transliterate() {
    for (const elem of document.querySelectorAll('tx')) {
      if (!elem.en) {
        elem.en = elem.innerText;
      }
      elem.innerText = F.phrase(elem.en);
      if (elem.getAttribute('glue')) {
        elem.innerText = elem.innerText.replace(/ /g, '');
      }
    }
  },

  async load() {
    const response = await window.gapi.client.sheets.spreadsheets.get({
      spreadsheetId,
      includeGridData: true,
    });
    const sheets = {};
    for (const sheet of response.result.sheets) {
      const rows = [];
      sheets[sheet.properties.title] = rows;
      let header;
      for (const row of sheet.data[0].rowData) {
        const cells = (row.values || []).map(v => ((v || {}).formattedValue || ''));
        if (sheet.properties.title !== 'words') {
          rows.push(cells);
          continue;
        }
        if (header) {
          rows.push(Object.fromEntries(header.map((h, i) => [h, cells[i] || ''])));
        } else {
          header = cells;
        }
      }
    }
    console.log(sheets);

    let table = document.getElementById('syllables');
    for (const row of sheets.syllables) {
      const tr = document.createElement('tr');
      table.appendChild(tr);
      for (let coli = 0; coli < 6; ++coli) {
        const td = document.createElement('td');
        tr.appendChild(td);
        td.innerText = row[coli] || '';
        td.addEventListener('click', () => {
          console.log('TODO highlight', row[coli]);
        });
      }
    }
    for (let rowi = 1; rowi < sheets.syllables.length; ++rowi) {
      for (let coli = 1; coli < sheets.syllables[rowi].length; ++coli) {
        const en = sheets.syllables[rowi][coli] || '';
        if (!en) continue;
        const fw = sheets.syllables[rowi][0] + sheets.syllables[0][coli];
        F.fw2en[fw] = en;
        F.en2fw[en] = fw;
      }
    }

    table = document.getElementById('words');
    let tr = document.createElement('tr');
    table.appendChild(tr);
    for (const head of ['roots', null, 'nouns', 'verbs', 'adjectives', 'adverbs', 'prepositions', 'score']) {
      const td = document.createElement('td');
      tr.appendChild(td);
      td.style.borderBottom = '2px solid black';
      if (head !== null) {
        td.innerText = head;
      } else {
        const tx = document.createElement('tx');
        td.appendChild(tx);
        tx.innerText = 'word few';
      } 
    }
    for (const row of sheets.words) {
      const fw = F.phrase(row.roots, true).replace(/ /g, '');
      F.fw2en[fw] = row.nouns.split('/')[0];
      for (const en of [...row.nouns.split('/'), ...row.verbs.split('/'), ...row.adjectives.split('/'), ...row.adverbs.split('/'), ...row.prepositions.split('/')]) {
        if (!en) continue;
        F.en2fw[en] = fw;
      }
      tr = document.createElement('tr');
      table.appendChild(tr);
      for (const cell of [row.roots, null, row.nouns, row.verbs, row.adjectives, row.adverbs, row.prepositions, row.score]) {
        const td = document.createElement('td');
        tr.appendChild(td);
        if (cell !== null) {
          td.innerText = cell.replace(/\//g, '/'+String.fromCharCode(0x200B));
        } else {
          const tx = document.createElement('tx');
          td.appendChild(tx);
          if (fw.length <= 10) tx.setAttribute('glue', true);
          tx.innerText = row.roots;
        }
      }
    }

    table = document.getElementById('tokipona');
    for (const row of sheets['source:tokipona']) {
      tr = document.createElement('tr');
      table.appendChild(tr);
      for (let coli = 0; coli < 2; ++coli) {
        const td = document.createElement('td');
        tr.appendChild(td);
        td.innerText = row[coli] || '';
      }
      const td = document.createElement('td');
      tr.appendChild(td);
      const tx = document.createElement('tx');
      td.appendChild(tx);
      tx.innerText = row[1];
      try {
        F.phrase(row[1], true)
      } catch (e) {
        console.log('TODO define', row[1]);
      }
    }

    table = document.getElementById('aui');
    for (const row of sheets['source:aUI']) {
      tr = document.createElement('tr');
      table.appendChild(tr);
      for (let coli = 0; coli < 3; ++coli) {
        const td = document.createElement('td');
        tr.appendChild(td);
        td.innerText = row[coli] || '';
      }
      const td = document.createElement('td');
      tr.appendChild(td);
      const tx = document.createElement('tx');
      td.appendChild(tx);
      tx.innerText = row[2] || '';
      try {
        F.phrase(row[2], true)
      } catch (e) {
        console.log('TODO define', row[1]);
      }
    }

    F.transliterate();

    sheets.about = Object.fromEntries(sheets.about);
    document.head.querySelector('title').innerText = F.phrase(sheets.about.name_tx, true);
    document.body.querySelector('#name_en').innerText = sheets.about.name;
    document.body.querySelector('tx#name').innerText = sheets.about.name_tx;
  },
};

addEventListener('load', () => {
  if (window.location.protocol === 'http:') {
    window.location.protocol = 'https:';
    return;
  }
  const script = document.createElement('script');
  script.async = 'async';
  script.defer = 'defer';
  script.src = 'https://apis.google.com/js/api.js';
  script.onreadystatechange = () => {
    if (this.readyState === 'complete') this.onload()
  };
  script.onload = () => {
    this.onload = function(){};
    window.gapi.load('client:auth2', function initClient() {
      window.gapi.client.init({
        clientId: '563656626445-ijrtluv6l4k9v8io4tinnl054onkmvaf.apps.googleusercontent.com',
        apiKey: 'AIzaSyCisRYYgsPjDE0DuiC2Wr8j7K8Mj2aFW-U',
        discoveryDocs: ['https://sheets.googleapis.com/$discovery/rest?version=v4'],
        scope: 'https://www.googleapis.com/auth/spreadsheets',
      }).then(async function () {
        updateSigninStatus();
        window.gapi.auth2.getAuthInstance().isSignedIn.listen(updateSigninStatus);
        document.getElementById('authorize_button').onclick = function handleAuthClick(event) {
          return window.gapi.auth2.getAuthInstance().signIn();
        };
      }, function(error) {
        document.body.innerText = JSON.stringify(error);
      });
    });
  };
  document.head.appendChild(script);
});

function updateSigninStatus() {
  if (window.gapi.auth2.getAuthInstance().isSignedIn.get()) {
    document.getElementById('authorize_button').style.display = 'none';
    F.load();
  } else {
    document.getElementById('authorize_button').style.display = 'block';
  }
}
</script>
