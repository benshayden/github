<!doctype html>
<title>The Final Daemon</title>
<style>
#input {
  margin-top: 1em;
}
</style>

<div id=log></div>
<div id=menu></div>
<input id=input autofocus style="width: 100%;">

<script>
// npcs at each tile

// localstorage state: map, log, location, team, npc_script_line, unlocked_species
// Each tile contains one of NPC, library, wild daemon camp, trainer, entrance, or mini-puzzle.
// minipuzzles yield potions which restore full health during battle, reset a potion puzzle.

async function sha(s) {
  s = new TextEncoder('utf-8').encode(s);
  const hash = await crypto.subtle.digest('SHA-256', s);
  const view = new DataView(hash);
  let hex = '';
  for (let i = 0; i < view.byteLength; i += 4) {
    hex += ('00000000' + view.getUint32(i).toString(16)).slice(-8);
  }
  return hex;
}

(function() {
const _LOG = document.getElementById('log');
function log(message) {
  const d = document.createElement('div');
  const t = document.createTextNode(message);
  d.appendChild(t);
  _LOG.appendChild(d);
}

const MODE = Object.fromEntries(`
  OVERWORLD BATTLE POSTBATTLE
`.trim().split().map(v => [v, v]));

const OVERWORLD = {
  _tiles: [new Array(3), new Array(3), new Array(3), new Array(3)],
  _queue: [
    {
      messages: ['Your home seems smaller somehow.'],
      dirs: ['inside'],
    },
    { // puzzle
      messages: [() => {}],
    },
    { // camp
    },
    { // library
    },
    { // camp
    },
    { // puzzle
    },
    { // trainer
    },
    { // library
    },
    { // camp
    },
    { // puzzle
    },
    { // final daemon
    },
    { // puzzle
    },
  ],
  describe() {
    const p = new Point(PLAYER.location.x, PLAYER.location.y);
    p.y %= this._tiles.length;
    p.x %= this._tiles[p.y].length;
    if (!this._tiles[p.y][p.x]) {
      this._tiles[p.y][p.x] = this._queue.shift();
    }
    const messages = [...this._tiles[p.y][p.x].messages || []];
    const dirs = 'north south east west'.split(' ');
    dirs.push(...this._tiles[p.y][p.x].dirs);
    dirs[dirs.length - 1] = 'or ' + dirs[dirs.length - 1];
    messages.push('You can go ' + dirs.join(', ') + '.');
    return messages;
  }
};
  
function commaOr(seq) {
  seq = [...seq];
  seq[seq.length - 1] = 'or ' + seq[seq.length - 1];
  return seq.join(', ');
}

const MENU = {
  _div: document.getElementById('menu'),
  _mode: MODE.OVERWORLD,

  _render(mode) {
    if (mode !== undefined) this._mode = mode;
    this._div.innerText = '';
    for (const message of this._info) {
      const d = document.createElement('div');
      d.innerText = message;
      this._div.appendChild(d);
    }
  },

  get _info() {
    if (SPECIES.filter(s => s.available).length === 0) {
      return [`Which daemon catches your eye: ${commaOr(SPECIES.slice(0, 3).map(s => s.species))}?`];
    }
    switch (this._mode) {
      case MODE.OVERWORLD: return OVERWORLD.describe();
      case MODE.BATTLE: return [
      ];
      case MODE.POSTBATTLE: return [
        this._postbattle,
      ];
    }
  },

  onMove() {
    this._render(MODE.OVERWORLD);
  },

  onBattleStart() {
    this._render(MODE.BATTLE);
  },

  onBattleEnd(daemon) {
    this._postbattle = `Hello! My name is ~~~~~~~~. I'm a tortoise daemon. What would you like to call me?`;
    this._render(MODE.POSTBATTLE);
  },

  onNickname() {
    this._render(MODE.OVERWORLD);
  },
};

document.getElementById('input').addEventListener('change', async function onInput() {
  const value = this.value;
  const lower = value.toLocaleLowerCase().trim();
  this.value = '';
  const dig = await sha(lower);
  const parts = lower.split(/ +/);
  const part0 = parts[0];
  console.log('parts:', parts);

  if (dig === 'a4a4db5d13cc2e00f26bd48597bfe25b43ff62c9ab66607568274f7b5af3222e') {
    PLAYER._monsters = SPECIES.map(s => {
      return {...s, name: s.species};
    };
    return;
  }

  if (['?', 'help'].includes(part0)) {
    // TODO
    return;
  }
    
  if (SPECIES.filter(s => s.available).length === 0) {
    for (const s of SPECIES) {
      if (part0 === s.species) {
        return;
      }
    }
  }

  if (part0 === 'go') {
    // TODO
    return;
  }

  if (part0 === 'approach') {
    // TODO
    return;
  }

  if (part0 === 'attack') {
    // TODO
    return;
  }

  if (TECH[part0]) {
    // TODO
    return;
  }

  if (part0 === 'switch') {
    // TODO
    return;
  }

  if (part0 === 'accept') {
    // TODO
    return;
  }

  if (part0 === 'reject') {
    // TODO
    return;
  }
});

class Point {
  constructor(x = 0, y = 0) {
    this.x = x;
    this.y = y;
  }

  distance(p) {
    const dx = this.x - p.x;
    const dy = this.y - p.y;
    return Math.sqrt(dx * dx + dy * dy);
  }
}

const TYPE = Object.fromEntries(`
  WATER FIRE EARTH
`.trim().split().map(v => [v, v]));

// STRENGTH[attacker][defenender]
const STRENGTH = {
  [TYPE.WATER]: {
    [TYPE.WATER]: 1,
    [TYPE.FIRE]: 1,
    [TYPE.EARTH]: 1,
  },
  [TYPE.FIRE]: {
    [TYPE.WATER]: 1,
    [TYPE.FIRE]: 1,
    [TYPE.EARTH]: 1,
  },
  [TYPE.EARTH]: {
    [TYPE.WATER]: 1,
    [TYPE.FIRE]: 1,
    [TYPE.EARTH]: 1,
  },
};

const HEALTHINESS = [
  [
    'It might not be able to take any more.',
  ],
  [
    'It could be worse.',
  ],
  [
    'It could use a bandaid',
  ],
  [
    'It could be better.',
  ],
  [
    'It looks hale.',
  ],
];

function randomChoice(s) {
  return s[Math.round(Math.random() * s.length)];
}

class Daemon {
  constructor() {
  }

  attack(defender) {
    defender.health = Math.max(0, defender.health - STRENGTH[this.type][defender.type]
      * this.attack / defender.defense);
  }

  defend(attacker) {
    this.health = Math.max(0, this.health - STRENGTH[attacker.type][this.type]
      * attacker.attack / this.defense);
  }

  get healthiness() {
    return randomChoice(HEALTHINESS[
      (this.health == this.maxHealth)
      ? (HEALTHINESS.length - 1)
      : Math.floor((HEALTHINESS.length - 1) * this.health / this.maxHealth)]);
  }
}
  
const SPECIES = [
  {
    species: 'frog',
    type: TYPE.WATER,
    power: 1,
    tech: 'squirt',
    available: false,
  },
  {
    species: 'grasshopper',
    type: TYPE.EARTH,
    power: 1,
    tech: 'seed',
    available: false,
  },
  {
    species: 'salamander',
    type: TYPE.FIRE,
    power: 1,
    tech: 'ember',
    available: false,
  },
];

const PLAYER = {
  location: {x: 0, y: 0},
  team: [],
};

addEventListener('load', () => {
  log(`
    You awaken to the feeling of being watched.
    As you open your eyes, you find three animal-shaped daemons sitting on your bed.
  `);
  MENU.onMove();
});

})();

// https://www.mapeditor.org/
// http://phaser.io/
// screens: choose starter, overworld, battle, postbattle accept
</script>

<div style="display: none; white-space: pre;">
You awaken to the feeling of being watched.
As you open your eyes, you find three animal-shaped daemons sitting on your bed.
Which daemon catches your eye: frog, grasshopper, or salamander?
The frog daemon notices your gaze and introduces itself while the other two disappear.
"Hello! I don't think I have a name yet. What will you call me?"
bob
"Sounds good to me. Let's go outside!"
Some frog daemons are playing in a fountain. One of them is watching you.
Some salamander daemons are keeping warm in a fire.
Some grasshopper daemons are watching grass grow.
Before you can stop it, bob approaches them.
The wild frog daemon attacked!
bob can attack or splash or run.
You can use a potion.
bob is hale.
The wild frog daemon is hale.
bob made a watery shield.
The wild frog daemon yields. Will you accept or reject its help on your journey?
"Hello! I don't think I have a name yet. What will you call me?"
charlie joins your party.
A man wearing a large grey coat is watching you with his frog daemon.
You can talk to them.You can go north, south, east, or west.bob is hale. You can reorder your party.The man's frog daemon attacked!Bob smells a library to the south.A tiny library decorated with candles sits by the path.You can enter the library.
You have been found worthy.
Salamander daemons will now be visible to you.
You have been found worthy.
Grasshopper daemons will now be visible to you.
Directly south of here, you will find the entrance to a cave.
Deep inside the cave, the final daemon works its mischief.
Whenever you feel prepared, you must journey through the cave and challenge it.
You can enter the cave.
You can challenge the final daemon.
The Final daemon yields.
// Take final daemon to stop polluters and avert cataclysm.

Bob plants a seed and it sprouts.
The mouse eats the sprout and returns to its hole. A moment later, it returns, dragging a small brass key.
Bob ignites the fuel.
Bob waters the sprout.
Bob joins your team.
Bob returns to their camp.

There is a group of ${daemon}. One of them is watching you.
There is a village to the ${direction}.
There is a river/ocean to the ${direction}.
There is a locked brass door in the north wall.
A small mouse watches you.
There is a small pile of grey dust by a cracked wall. It smells of gunpowder.
There is a bed of fresh loamy soil.
A tortoise daemon is following you. It looks hale.

Scientists started warning of the cataclysm just when the daemons appeared.
Many believe the daemons will cause the cataclysm, and fear them.
Can you make peace in time to save the world?
They say the cataclysm will be a great fire.
They say the cataclysm will be a great flood.
They say the cataclysm will be a great plague.
The final daemon directs the cataclysm.
The final daemon isn't really a daemon.
The final daemon is guarded by an elite squad containing one of every type of daemon.
There are N species of daemons.
There are N types of daemons.
Water daemons fare well against fire daemons.
Fire daemons fare well against earth daemons.
Earth daemons fare well against water daemons.
</div>
