<!doctype html>
<title>Keymaps</title>
<style>
.rowpin { border: 2px solid green; width: 1.2em; text-align: right; padding: 1px; }
.colpin { border: 2px solid blue; width: 1.2em; text-align: right; padding: 1px; }
.error { border: 2px solid red; }
.strength { border: 2px solid black; width: 1.2em; text-align: right; padding: 1px; }
.modekey { display: block; width: 5em; }
</style>
<table>
<tr id=rowpins>
  <td>Row pins:</td>
  <td><input class=rowpin value=0></td>
  <td><input class=rowpin value=1></td>
  <td><input class=rowpin value=2></td>
  <td><input class=rowpin value=3></td>
  <td><input class=rowpin value=4></td>
  <td><input class=rowpin value=5></td>
</tr>
<tr id=colpins>
  <td>Column pins:</td>
  <td><input class=colpin value=16></td>
  <td><input class=colpin value=17></td>
  <td><input class=colpin value=18></td>
  <td><input class=colpin value=19></td>
  <td><input class=colpin value=20></td>
  <td><input class=colpin value=21></td>
</tr>
</table>
<table id=pinmap>
  <tr>
    <td>pinky</td>
    <td>ring</td>
    <td>middle</td>
    <td>index</td>
    <td>thumb</td>
    <td>thumb</td>
    <td>index</td>
    <td>middle</td>
    <td>ring</td>
    <td>pinky</td>
  </tr>
  <tr>
    <td>
      <input class=strength value=0>
      <input class=rowpin value=0>
      <input class=colpin value=16>
      <input class=modekey value='z'>
      <input class=modekey value='`'>
    </td>
    <td>
      <input class=strength value=10>
      <input class=rowpin value=0>
      <input class=colpin value=17>
      <input class=modekey value='b'>
      <input class=modekey value='['>
    </td>
    <td>
      <input class=strength value=30>
      <input class=rowpin value=0>
      <input class=colpin value=18>
      <input class=modekey value='m'>
      <input class=modekey value="'">
    </td>
    <td>
      <input class=strength value=50>
      <input class=rowpin value=0>
      <input class=colpin value=19>
      <input class=modekey value='h'>
      <input class=modekey value='UP'>
    </td>
    <td>
      <input class=strength value=90>
      <input class=rowpin value=0>
      <input class=colpin value=20>
      <input class=modekey value='BACKSPACE'>
      <input class=modekey value='='>
    </td>
    <td>
      <input class=strength value=90>
      <input class=rowpin value=3>
      <input class=colpin value=20>
      <input class=modekey value='ENTER'>
      <input class=modekey value='TAB'>
    </td>
    <td>
      <input class=strength value=50>
      <input class=rowpin value=3>
      <input class=colpin value=19>
      <input class=modekey value='s'>
      <input class=modekey value='7'>
    </td>
    <td>
      <input class=strength value=30>
      <input class=rowpin value=3>
      <input class=colpin value=18>
      <input class=modekey value='u'>
      <input class=modekey value='8'>
    </td>
    <td>
      <input class=strength value=10>
      <input class=rowpin value=3>
      <input class=colpin value=17>
      <input class=modekey value='p'>
      <input class=modekey value='9'>
    </td>
    <td>
      <input class=strength value=0>
      <input class=rowpin value=3>
      <input class=colpin value=16>
      <input class=modekey value='q'>
      <input class=modekey value='VOLDN'>
    </td>
  </tr>
  <tr>
    <td>
      <input class=strength value=0>
      <input class=rowpin value=1>
      <input class=colpin value=16>
      <input class=modekey value='x'>
      <input class=modekey value='|'>
    </td>
    <td>
      <input class=strength value=10>
      <input class=rowpin value=1>
      <input class=colpin value=17>
      <input class=modekey value='y'>
      <input class=modekey value='/'>
    </td>
    <td>
      <input class=strength value=30>
      <input class=rowpin value=1>
      <input class=colpin value=18>
      <input class=modekey value='c'>
      <input class=modekey value='LEFT'>
    </td>
    <td>
      <input class=strength value=50>
      <input class=rowpin value=1>
      <input class=colpin value=19>
      <input class=modekey value='n'>
      <input class=modekey value='RIGHT'>
    </td>
    <td>
      <input class=strength value=90>
      <input class=rowpin value=1>
      <input class=colpin value=20>
      <input class=modekey value=' '>
      <input class=modekey value='CTRL'>
    </td>
    <td>
      <input class=strength value=90>
      <input class=rowpin value=4>
      <input class=colpin value=20>
      <input class=modekey value='MODE'>
      <input class=modekey value='MODE'>
    </td>
    <td>
      <input class=strength value=50>
      <input class=rowpin value=4>
      <input class=colpin value=19>
      <input class=modekey value='i'>
      <input class=modekey value='4'>
    </td>
    <td>
      <input class=strength value=30>
      <input class=rowpin value=4>
      <input class=colpin value=18>
      <input class=modekey value='l'>
      <input class=modekey value='5'>
    </td>
    <td>
      <input class=strength value=10>
      <input class=rowpin value=4>
      <input class=colpin value=17>
      <input class=modekey value='g'>
      <input class=modekey value='6'>
    </td>
    <td>
      <input class=strength value=0>
      <input class=rowpin value=4>
      <input class=colpin value=16>
      <input class=modekey value='v'>
      <input class=modekey value='VOLUP'>
    </td>
  </tr>
  <tr>
    <td>
      <input class=strength value=0>
      <input class=rowpin value=2>
      <input class=colpin value=16>
      <input class=modekey value='k'>
      <input class=modekey value='\'>
    </td>
    <td>
      <input class=strength value=10>
      <input class=rowpin value=2>
      <input class=colpin value=17>
      <input class=modekey value='f'>
      <input class=modekey value=']'>
    </td>
    <td>
      <input class=strength value=30>
      <input class=rowpin value=2>
      <input class=colpin value=18>
      <input class=modekey value='d'>
      <input class=modekey value='.'>
    </td>
    <td>
      <input class=strength value=50>
      <input class=rowpin value=2>
      <input class=colpin value=19>
      <input class=modekey value='o'>
      <input class=modekey value='DOWN'>
    </td>
    <td>
      <input class=strength value=90>
      <input class=rowpin value=2>
      <input class=colpin value=20>
      <input class=modekey value='e'>
      <input class=modekey value=','>
    </td>
    <td>
      <input class=strength value=90>
      <input class=rowpin value=5>
      <input class=colpin value=20>
      <input class=modekey value=';'>
      <input class=modekey value='0'>
    </td>
    <td>
      <input class=strength value=50>
      <input class=rowpin value=5>
      <input class=colpin value=19>
      <input class=modekey value='a'>
      <input class=modekey value='1'>
    </td>
    <td>
      <input class=strength value=30>
      <input class=rowpin value=5>
      <input class=colpin value=18>
      <input class=modekey value='r'>
      <input class=modekey value='2'>
    </td>
    <td>
      <input class=strength value=10>
      <input class=rowpin value=5>
      <input class=colpin value=17>
      <input class=modekey value='w'>
      <input class=modekey value='3'>
    </td>
    <td>
      <input class=strength value=0>
      <input class=rowpin value=5>
      <input class=colpin value=16>
      <input class=modekey value='j'>
      <input class=modekey value='MACRO'>
    </td>
  </tr>
  <tr>
    <td>&nbsp;</td>
    <td>&nbsp;</td>
    <td>&nbsp;</td>
    <td>&nbsp;</td>
    <td>
      <input class=strength value=90>
      <input class=rowpin value=0>
      <input class=colpin value=21>
      <input class=modekey value='t'>
      <input class=modekey value='-'>
    </td>
    <td>
      <input class=strength value=90>
      <input class=rowpin value=3>
      <input class=colpin value=21>
      <input class=modekey value='SHIFT'>
      <input class=modekey value='SHIFT'>
    </td>
  </tr>
</table>
<textarea id=keymaps cols=100 rows=10></textarea>
<script>
function qSA(s, p) {
  return Array.prototype.slice.apply((p || document).querySelectorAll(s));
}
function buildkeymaps() {
  var rowpinnums = [];
  var colpinnums = [];
  qSA('input', rowpins).forEach(function(input) {
    rowpinnums.push(input.value);
  });
  qSA('input', colpins).forEach(function(input) {
    colpinnums.push(input.value);
  });
  var keymapkeys = [[[], [], [], [], [], []], [[], [], [], [], [], []]];
  var pinsmap = {};
  var keysmap = {};
  var hadError = false;
  for (var rowi = 0; rowi < rowpinnums.length; ++rowi) {
    for (var coli = 0; coli < colpinnums.length; ++coli) {
      keymapkeys[0][rowi][coli] = 0;
      keymapkeys[1][rowi][coli] = 0;
    }
  }
  qSA('td', pinmap).forEach(function(td) {
    var strengthinput = td.querySelector('.strength');
    var rowpininput = td.querySelector('.rowpin');
    var colpininput = td.querySelector('.colpin');
    var keyinputs = td.querySelectorAll('.modekey');
    if (!rowpininput || !colpininput || !keyinputs) {
      return;
    }
    var rowpin = rowpininput.value;
    var colpin = colpininput.value;
    var key0 = keyinputs[0].value;
    var key1 = keyinputs[1].value;
    var rowpini = rowpinnums.indexOf(rowpin);
    var colpini = colpinnums.indexOf(colpin);
    if ((rowpini < 0) || pinsmap[rowpini + ',' + colpini]) {
      rowpininput.classList.add('error');
      hadError = true;
    } else {
      rowpininput.classList.remove('error');
    }
    if ((colpini < 0) || pinsmap[rowpini + ',' + colpini]) {
      colpininput.classList.add('error');
      hadError = true;
    } else {
      colpininput.classList.remove('error');
    }
    if (!key0 || keysmap[key0]) {
      keyinputs[0].classList.add('error');
      hadError = true;
    } else {
      keyinputs[0].classList.remove('error');
    }
    if (!key1 || keysmap[key1]) {
      keyinputs[1].classList.add('error');
      hadError = true;
    } else {
      keyinputs[1].classList.remove('error');
    }
    keymapkeys[0][rowpini][colpini] = key0;
    keymapkeys[1][rowpini][colpini] = key1;
    if (keysmap[key0]) {
      keysmap[key0].classList.add('error');
      hadError = true;
    }
    if (keysmap[key1]) {
      keysmap[key1].className.add('error');
      hadError = true;
    }
    if (pinsmap[rowpini + ',' + colpini]) {
      pinsmap[rowpini + ',' + colpini][0].classList.add('error');
      pinsmap[rowpini + ',' + colpini][1].classList.add('error');
      hadError = true;
    }
    keysmap[key0] = keyinputs[0];
    keysmap[key1] = keyinputs[1];
    pinsmap[rowpini + ',' + colpini] = [rowpininput, colpininput];
  });
  if (hadError)
    return;
  keymaps.value = '{' + keymapkeys.map(function(keymap) {
    return keymap.map(function(row) {
      return row.map(function(key) {
        if (typeof key === 'number') {
          return '' + key;
        } else if (key.length > 1) {
          return 'KEY_' + key;
        } else if (key === "'") {
          return "'\\''";
        } else if (key === '\\') {
          return "'\\\\'";
        } else {
          return "'" + key + "'";
        }
      }).join(', ');
    }).join(', ');
  }).join('},\n{') + '}';
}
qSA('input').forEach(function(input) {
  input.addEventListener('keyup', buildkeymaps);
});
buildkeymaps();
function assignByStrength(keys, mode) {
  var strengths = qSA('input.strength');
  strengths.sort(function(a, b) {
    return parseFloat(a.value) - parseFloat(b.value);
  });
  strengths.forEach(function(strengthinput, i) {
    strengthinput.parentNode.querySelectorAll('.modekey')[mode || 0].value = keys[i];
  });
}
</script>
