<!doctype html>
<title>Keymaps</title>
<style>
.rowpin { border: 2px solid green; width: 1.5em; }
.colpin { border: 2px solid blue; width: 1.5em; }
.error { border: 2px solid red; width: 1.5em; }
.modekey { display: block; width: 4em; }
</style>
<table>
<tr id=rowpins>
  <td>Row pins:</td>
  <td><input class=rowpin value=0></td>
  <td><input class=rowpin value=1></td>
  <td><input class=rowpin value=2></td>
  <td><input class=rowpin value=3></td>
  <td><input class=rowpin value=4></td>
  <td><input class=rowpin value=5></td>
</tr>
<tr id=colpins>
  <td>Column pins:</td>
  <td><input class=colpin value=16></td>
  <td><input class=colpin value=17></td>
  <td><input class=colpin value=18></td>
  <td><input class=colpin value=19></td>
  <td><input class=colpin value=20></td>
  <td><input class=colpin value=21></td>
</tr>
</table>
<table id=pinmap>
  <tr>
    <td>left pinky</td>
    <td>left ring</td>
    <td>left middle</td>
    <td>left index</td>
    <td>left thumb</td>
    <td>right thumb</td>
    <td>right index</td>
    <td>right middle</td>
    <td>right ring</td>
    <td>right pinky</td>
  </tr>
  <tr>
    <td>
      <input class=rowpin value=0>
      <input class=colpin value=16>
      <input class=modekey value='z'>
      <input class=modekey value='`'>
    </td>
    <td>
      <input class=rowpin value=0>
      <input class=colpin value=17>
      <input class=modekey value='b'>
      <input class=modekey value='['>
    </td>
    <td>
      <input class=rowpin value=0>
      <input class=colpin value=18>
      <input class=modekey value='m'>
      <input class=modekey value="'">
    </td>
    <td>
      <input class=rowpin value=0>
      <input class=colpin value=19>
      <input class=modekey value='h'>
      <input class=modekey value='UP'>
    </td>
    <td>
      <input class=rowpin value=0>
      <input class=colpin value=20>
      <input class=modekey value='BACKSPACE'>
      <input class=modekey value='='>
    </td>
    <td>
      <input class=rowpin value=3>
      <input class=colpin value=20>
      <input class=modekey value='ENTER'>
      <input class=modekey value='TAB'>
    </td>
    <td>
      <input class=rowpin value=3>
      <input class=colpin value=19>
      <input class=modekey value='s'>
      <input class=modekey value='7'>
    </td>
    <td>
      <input class=rowpin value=3>
      <input class=colpin value=18>
      <input class=modekey value='u'>
      <input class=modekey value='8'>
    </td>
    <td>
      <input class=rowpin value=3>
      <input class=colpin value=17>
      <input class=modekey value='p'>
      <input class=modekey value='9'>
    </td>
    <td>
      <input class=rowpin value=3>
      <input class=colpin value=16>
      <input class=modekey value='q'>
      <input class=modekey value='VOLDN'>
    </td>
  </tr>
  <tr>
    <td>
      <input class=rowpin value=1>
      <input class=colpin value=16>
      <input class=modekey value='x'>
      <input class=modekey value='|'>
    </td>
    <td>
      <input class=rowpin value=1>
      <input class=colpin value=17>
      <input class=modekey value='y'>
      <input class=modekey value='/'>
    </td>
    <td>
      <input class=rowpin value=1>
      <input class=colpin value=18>
      <input class=modekey value='c'>
      <input class=modekey value='LEFT'>
    </td>
    <td>
      <input class=rowpin value=1>
      <input class=colpin value=19>
      <input class=modekey value='n'>
      <input class=modekey value='RIGHT'>
    </td>
    <td>
      <input class=rowpin value=1>
      <input class=colpin value=20>
      <input class=modekey value=' '>
      <input class=modekey value='CTRL'>
    </td>
    <td>
      <input class=rowpin value=4>
      <input class=colpin value=20>
      <input class=modekey value='MODE'>
      <input class=modekey value='MODE'>
    </td>
    <td>
      <input class=rowpin value=4>
      <input class=colpin value=19>
      <input class=modekey value='i'>
      <input class=modekey value='4'>
    </td>
    <td>
      <input class=rowpin value=4>
      <input class=colpin value=18>
      <input class=modekey value='l'>
      <input class=modekey value='5'>
    </td>
    <td>
      <input class=rowpin value=4>
      <input class=colpin value=17>
      <input class=modekey value='g'>
      <input class=modekey value='6'>
    </td>
    <td>
      <input class=rowpin value=4>
      <input class=colpin value=16>
      <input class=modekey value='v'>
      <input class=modekey value='VOLUP'>
    </td>
  </tr>
  <tr>
    <td>
      <input class=rowpin value=2>
      <input class=colpin value=16>
      <input class=modekey value='k'>
      <input class=modekey value='\'>
    </td>
    <td>
      <input class=rowpin value=2>
      <input class=colpin value=17>
      <input class=modekey value='f'>
      <input class=modekey value=']'>
    </td>
    <td>
      <input class=rowpin value=2>
      <input class=colpin value=18>
      <input class=modekey value='d'>
      <input class=modekey value='.'>
    </td>
    <td>
      <input class=rowpin value=2>
      <input class=colpin value=19>
      <input class=modekey value='o'>
      <input class=modekey value='DOWN'>
    </td>
    <td>
      <input class=rowpin value=2>
      <input class=colpin value=20>
      <input class=modekey value='e'>
      <input class=modekey value=','>
    </td>
    <td>
      <input class=rowpin value=5>
      <input class=colpin value=20>
      <input class=modekey value=';'>
      <input class=modekey value='0'>
    </td>
    <td>
      <input class=rowpin value=5>
      <input class=colpin value=19>
      <input class=modekey value='a'>
      <input class=modekey value='1'>
    </td>
    <td>
      <input class=rowpin value=5>
      <input class=colpin value=18>
      <input class=modekey value='r'>
      <input class=modekey value='2'>
    </td>
    <td>
      <input class=rowpin value=5>
      <input class=colpin value=17>
      <input class=modekey value='w'>
      <input class=modekey value='3'>
    </td>
    <td>
      <input class=rowpin value=5>
      <input class=colpin value=16>
      <input class=modekey value='j'>
      <input class=modekey value='MACRO'>
    </td>
  </tr>
  <tr>
    <td>&nbsp;</td>
    <td>&nbsp;</td>
    <td>&nbsp;</td>
    <td>&nbsp;</td>
    <td>
      <input class=rowpin value=0>
      <input class=colpin value=21>
      <input class=modekey value='t'>
      <input class=modekey value='-'>
    </td>
    <td>
      <input class=rowpin value=3>
      <input class=colpin value=21>
      <input class=modekey value='SHIFT'>
      <input class=modekey value='SHIFT'>
    </td>
  </tr>
</table>
<textarea id=keymaps cols=100 rows=10></textarea>
<script>
function qSA(s, p) {
  return Array.prototype.slice.apply((p || document).querySelectorAll(s));
}
function buildkeymaps() {
  var rowpinnums = [];
  var colpinnums = [];
  qSA('input', rowpins).forEach(function(input) {
    rowpinnums.push(input.value);
  });
  qSA('input', colpins).forEach(function(input) {
    colpinnums.push(input.value);
  });
  var keymapkeys = [[[], [], [], [], [], []], [[], [], [], [], [], []]];
  var pinsmap = {};
  var keysmap = {};
  var hadError = false;
  for (var rowi = 0; rowi < rowpinnums.length; ++rowi) {
    for (var coli = 0; coli < colpinnums.length; ++coli) {
      keymapkeys[0][rowi][coli] = 0;
      keymapkeys[1][rowi][coli] = 0;
    }
  }
  qSA('td', pinmap).forEach(function(td) {
    var inputs = td.querySelectorAll('input');
    if (inputs.length === 0) return;
    var rowpin = inputs[0].value;
    var colpin = inputs[1].value;
    var key0 = inputs[2].value;
    var key1 = inputs[3].value;
    var rowpini = rowpinnums.indexOf(rowpin);
    var colpini = colpinnums.indexOf(colpin);
    inputs[0].className = ((rowpini < 0) || pinsmap[rowpini + ',' + colpini]) ? 'error' : 'rowpin';
    inputs[1].className = ((colpini < 0) || pinsmap[rowpini + ',' + colpini]) ? 'error' : 'colpin';
    inputs[2].className = 'modekey ' + ((key0 && !keysmap[key0]) ? '' : 'error');
    inputs[3].className = 'modekey ' + ((key1 && !keysmap[key1]) ? '' : 'error');
    hadError = hadError || (rowpini < 0) || (colpini < 0) || !key0 || !key1 || keysmap[key0] || keysmap[key1] || pinsmap[rowpini + ',' + colpini];
    keymapkeys[0][rowpini][colpini] = key0;
    keymapkeys[1][rowpini][colpini] = key1;
    if (keysmap[key0]) {
      keysmap[key0].className = 'error';
    }
    if (keysmap[key1]) {
      keysmap[key1].className = 'error';
    }
    if (pinsmap[rowpini + ',' + colpini]) {
      pinsmap[rowpini + ',' + colpini][0].className = 'error';
      pinsmap[rowpini + ',' + colpini][1].className = 'error';
    }
    keysmap[key0] = inputs[2];
    keysmap[key1] = inputs[3];
    pinsmap[rowpini + ',' + colpini] = [inputs[0], inputs[1]];
  });
  if (hadError)
    return;
  keymaps.value = '{' + keymapkeys.map(function(keymap) {
    return keymap.map(function(row) {
      return row.map(function(key) {
        if (typeof key === 'number') {
          return '' + key;
        } else if (key.length > 1) {
          return 'KEY_' + key;
        } else if (key === "'") {
          return "'\\''";
        } else if (key === '\\') {
          return "'\\\\'";
        } else {
          return "'" + key + "'";
        }
      }).join(', ');
    }).join(', ');
  }).join('},\n{') + '}';
  save();
}
qSA('input').forEach(function(input) {
  input.addEventListener('keyup', buildkeymaps);
});
function save() {
  var inputs = qSA('input');
  try {
    localStorage[location.pathname] = JSON.stringify(inputs.map(function(input) {
      return input.value;
    }));
  } catch (e) {
  }
}
function restore() {
  try {
    var saved = localStorage[location.pathname];
  } catch (e) {
    return;
  }
  if (!saved) return;
  try {
    saved = JSON.parse(saved);
  } catch (e) {
    return;
  }
  var inputs = qSA('input');
  saved.forEach(function(value, index) {
    inputs[index].value = value;
  });
}
restore();
buildkeymaps();
</script>
