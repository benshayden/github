<canvas id=canvas>
<script>
const MS_PER_HOUR = 1000 * 60 * 60;
function convertTemp(k, metric = true) {
  const c = k - 273.15;
  return metric ? c : (c * (9 / 5) + 32);
}
const SCALAR_NAMES = ['temp', 'feels_like', 'wind_speed', 'humidity', 'pressure'];
navigator.geolocation.getCurrentPosition(async (pos) => {
  const lat = parseInt(pos.coords.latitude * 10) / 10;
  const lon = parseInt(pos.coords.longitude * 10) / 10;
  const cacheKey = `${lat} ${lon}`;
  const cached = JSON.parse(localStorage.getItem(cacheKey) || 'null');
  const now = new Date();
  let result;
  if (cached && (MS_PER_HOUR > (cached && (now - new Date(cached.ts))))) {
    result = cached.result;
  } else {
    result = await (await fetch(`https://api.openweathermap.org/data/2.5/onecall?lat=${lat}&lon=${lon}&appid=4f7a34d2b44e009df9246dbca025d0b5`)).json();
    result.uvforecast = (await (await fetch(`https://api.openuv.io/api/v1/forecast?lat=${lat}&lng=${lon}`, {
      headers: {'x-access-token': '0e881fcec14d82a8eb011877e61bfc21'},
    })).json()).result.map(h => ({t: new Date(h.uv_time), uv: h.uv}));
    localStorage.setItem(cacheKey, JSON.stringify({ts: now, result}));
  }
  const metric = localStorage.getItem('metric') !== null;
  console.log(result);
  const ctx = canvas.getContext('2d');

  for (const k of ['temp', 'feels_like']) {
    for (const h of result.hourly) {
      h[k] = convertTemp(h[k], metric);
    }
    for (const d of result.daily) {
      for (const x of Object.keys(d[k])) {
        d[k][x] = convertTemp(d[k][x], metric);
      }
    }
  }

  result.maxima = {};
  result.minima = {};
  for (const h of result.hourly) {
    h.date = new Date(h.dt * 1000);
    result.hours[h.date.getHours()] = h;
    for (const k of SCALAR_NAMES) {
      result.maxima[k] = Math.max(result.maxima[k] || 0, h[k]);
      result.minima[k] = Math.min(result.minima[k] || 1000000, h[k]);
    }
    if (h.hour > 20) break;
  }
  
  // TODO adjust uvforecast for clouds

  for (let h = now.getHours(); h < 20; ++h) {
    ctx.fillText(h, 0, 20 * (h - now.getHours()));
  }
});
</script>
